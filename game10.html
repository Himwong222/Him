<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«”æ„ŸåŒ…å‰ªæ¼ | Him Wong éŠæˆ²é¤¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 25px;
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: #6c63ff;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            color: #aaa;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .game-area {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .camera-section {
            flex: 1;
            min-width: 300px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .section-title {
            color: #6c63ff;
            margin-bottom: 15px;
            font-size: 1.4rem;
            border-bottom: 2px solid #6c63ff;
            padding-bottom: 8px;
        }

        #camera-container {
            width: 100%;
            height: 300px;
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-bottom: 15px;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* é¡åƒç¿»è½‰ï¼Œè®“å®ƒæ›´åƒé¡å­ */
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 12px 25px;
            background-color: #6c63ff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            flex: 1;
        }

        button:hover {
            background-color: #5a52d5;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(1px);
        }

        button:disabled {
            background-color: #3d3d5c;
            cursor: not-allowed;
            transform: none;
        }

        #start-btn {
            background-color: #4CAF50;
        }

        #start-btn:hover:not(:disabled) {
            background-color: #45a049;
        }

        #stop-btn {
            background-color: #ff6b6b;
        }

        #stop-btn:hover:not(:disabled) {
            background-color: #ff5252;
        }

        .game-section {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
        }

        .gesture-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .gesture-box {
            background-color: #2d2d44;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            flex: 1;
            margin: 0 10px;
            transition: all 0.3s;
        }

        .gesture-box.active {
            background-color: #3d3d5c;
            box-shadow: 0 0 15px rgba(108, 99, 255, 0.5);
        }

        .gesture-icon {
            font-size: 4rem;
            margin-bottom: 10px;
        }

        .gesture-name {
            font-size: 1.3rem;
            color: #ffd166;
        }

        .gesture-status {
            font-size: 1.1rem;
            color: #aaa;
            margin-top: 5px;
        }

        .game-controls {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .game-state {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .countdown {
            font-size: 3rem;
            color: #ff6b6b;
            font-weight: bold;
            text-align: center;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(255, 107, 107, 0.1);
            border: 5px solid #ff6b6b;
        }

        .vs {
            font-size: 2rem;
            color: #ffd166;
            font-weight: bold;
        }

        .game-result {
            text-align: center;
            font-size: 1.8rem;
            margin: 15px 0;
            min-height: 50px;
            color: #6c63ff;
            font-weight: bold;
        }

        .scoreboard {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .score-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .score-box {
            background-color: #2d2d44;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            flex: 1;
            margin: 0 10px;
        }

        .score-label {
            font-size: 1rem;
            color: #aaa;
            margin-bottom: 10px;
        }

        .score-value {
            font-size: 2.5rem;
            color: #6c63ff;
            font-weight: bold;
        }

        .game-history {
            margin-top: 20px;
        }

        .history-title {
            color: #6c63ff;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        #history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            background-color: #2d2d44;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .history-winner {
            color: #4CAF50;
            font-weight: bold;
        }

        .history-looser {
            color: #ff6b6b;
        }

        .instructions {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            max-width: 800px;
        }

        .instructions h3 {
            color: #6c63ff;
            margin-bottom: 15px;
        }

        .instructions-list {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .instructions-list li {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .instructions-list strong {
            color: #ffd166;
        }

        .gesture-guide {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .guide-item {
            text-align: center;
            flex: 1;
            min-width: 150px;
        }

        .guide-icon {
            font-size: 3.5rem;
            margin-bottom: 10px;
        }

        .guide-text {
            color: #aaa;
        }

        footer {
            margin-top: 30px;
            text-align: center;
            color: #aaa;
            font-size: 0.9rem;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10;
            border-radius: 10px;
        }

        .spinner {
            border: 5px solid #3d3d5c;
            border-top: 5px solid #6c63ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .detection-status {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.2);
            font-size: 0.9rem;
            color: #aaa;
        }

        .detection-status.active {
            color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }

        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            .gesture-info {
                flex-direction: column;
                gap: 15px;
            }
            
            .gesture-box {
                margin: 0;
            }
            
            .score-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .score-box {
                margin: 0;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .gesture-guide {
                flex-direction: column;
                align-items: center;
            }
        }

        @media (max-width: 480px) {
            .camera-controls {
                flex-direction: column;
            }
            
            .game-state {
                flex-direction: column;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>âœŠâœŒï¸âœ‹ é«”æ„ŸåŒ…å‰ªæ¼</h1>
            <p class="subtitle">ä½¿ç”¨æ‚¨çš„æ”åƒé ­é€²è¡Œé«”æ„ŸçŒœæ‹³éŠæˆ²ï¼</p>
        </header>
        
        <div class="game-area">
            <div class="camera-section">
                <h3 class="section-title">æ”åƒé ­ç•«é¢</h3>
                <div id="camera-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨è¼‰å…¥æ‰‹éƒ¨è­˜åˆ¥æ¨¡å‹...</p>
                    </div>
                </div>
                
                <div class="detection-status" id="detection-status">
                    ç­‰å¾…å•Ÿå‹•æ”åƒé ­...
                </div>
                
                <div class="camera-controls">
                    <button id="start-btn">å•Ÿå‹•æ”åƒé ­</button>
                    <button id="stop-btn" disabled>åœæ­¢æ”åƒé ­</button>
                    <button id="game-btn" disabled>é–‹å§‹éŠæˆ²</button>
                </div>
            </div>
            
            <div class="game-section">
                <div class="gesture-info">
                    <div class="gesture-box" id="player-gesture">
                        <div class="gesture-icon">?</div>
                        <div class="gesture-name">ç©å®¶æ‰‹å‹¢</div>
                        <div class="gesture-status" id="player-status">ç­‰å¾…æª¢æ¸¬</div>
                    </div>
                    
                    <div class="gesture-box" id="ai-gesture">
                        <div class="gesture-icon">?</div>
                        <div class="gesture-name">é›»è…¦æ‰‹å‹¢</div>
                        <div class="gesture-status" id="ai-status">ç­‰å¾…éŠæˆ²é–‹å§‹</div>
                    </div>
                </div>
                
                <div class="game-controls">
                    <div class="game-state">
                        <div class="gesture-box">
                            <div class="gesture-icon">ğŸ‘¤</div>
                            <div class="gesture-name">ç©å®¶</div>
                        </div>
                        
                        <div class="countdown" id="countdown">3</div>
                        
                        <div class="gesture-box">
                            <div class="gesture-icon">ğŸ¤–</div>
                            <div class="gesture-name">é›»è…¦</div>
                        </div>
                    </div>
                    
                    <div class="game-result" id="game-result">
                        æº–å‚™é–‹å§‹éŠæˆ²ï¼
                    </div>
                </div>
                
                <div class="scoreboard">
                    <div class="score-row">
                        <div class="score-box">
                            <div class="score-label">ç©å®¶å¾—åˆ†</div>
                            <div class="score-value" id="player-score">0</div>
                        </div>
                        
                        <div class="score-box">
                            <div class="score-label">å¹³å±€</div>
                            <div class="score-value" id="draw-score">0</div>
                        </div>
                        
                        <div class="score-box">
                            <div class="score-label">é›»è…¦å¾—åˆ†</div>
                            <div class="score-value" id="ai-score">0</div>
                        </div>
                    </div>
                    
                    <div class="game-history">
                        <div class="history-title">éŠæˆ²è¨˜éŒ„</div>
                        <div id="history-list">
                            <div class="history-item">éŠæˆ²å°šæœªé–‹å§‹</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>éŠæˆ²èªªæ˜</h3>
            <ul class="instructions-list">
                <li>é»æ“Š<strong>å•Ÿå‹•æ”åƒé ­</strong>æŒ‰éˆ•ï¼Œå…è¨±ç€è¦½å™¨è¨ªå•æ‚¨çš„æ”åƒé ­ã€‚</li>
                <li>å°‡æ‚¨çš„æ‰‹æ”¾åœ¨æ”åƒé ­å‰ï¼Œç¢ºä¿å…‰ç·šå……è¶³ï¼ŒèƒŒæ™¯ç°¡å–®ã€‚</li>
                <li>é»æ“Š<strong>é–‹å§‹éŠæˆ²</strong>æŒ‰éˆ•é–‹å§‹ä¸€è¼ªçŒœæ‹³éŠæˆ²ã€‚</li>
                <li>éŠæˆ²é–‹å§‹å¾Œï¼Œå€’æ•¸3ç§’ï¼Œè«‹åœ¨å€’æ•¸çµæŸå‰æ“ºå¥½æ‰‹å‹¢ã€‚</li>
                <li>ç³»çµ±æœƒæª¢æ¸¬æ‚¨çš„æ‰‹å‹¢ï¼ˆå‰ªåˆ€âœŒï¸ã€çŸ³é ­âœŠã€å¸ƒâœ‹ï¼‰ï¼Œä¸¦èˆ‡é›»è…¦éš¨æ©Ÿç”Ÿæˆçš„æ‰‹å‹¢æ¯”è¼ƒã€‚</li>
                <li>éŠæˆ²è¦å‰‡ï¼šå‰ªåˆ€è´å¸ƒã€å¸ƒè´çŸ³é ­ã€çŸ³é ­è´å‰ªåˆ€ã€‚</li>
                <li>éŠæˆ²çµæœæœƒè¨˜éŒ„åœ¨ä¸‹æ–¹ï¼Œä¸¦æ›´æ–°å¾—åˆ†ã€‚</li>
            </ul>
            
            <div class="gesture-guide">
                <div class="guide-item">
                    <div class="guide-icon">âœŠ</div>
                    <div class="guide-text">æ¡æ‹³è¡¨ç¤ºã€ŒçŸ³é ­ã€</div>
                </div>
                
                <div class="guide-item">
                    <div class="guide-icon">âœŒï¸</div>
                    <div class="guide-text">ä¼¸å‡ºé£ŸæŒ‡å’Œä¸­æŒ‡è¡¨ç¤ºã€Œå‰ªåˆ€ã€</div>
                </div>
                
                <div class="guide-item">
                    <div class="guide-icon">âœ‹</div>
                    <div class="guide-text">å¼µé–‹æ‰‹æŒè¡¨ç¤ºã€Œå¸ƒã€</div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Him Wong éŠæˆ²é¤¨ | é«”æ„ŸåŒ…å‰ªæ¼éŠæˆ² Â© 2023 | ä½¿ç”¨TensorFlow.js Handposeæ¨¡å‹</p>
        </footer>
    </div>

    <!-- è¼‰å…¥TensorFlow.jså’ŒHandposeæ¨¡å‹ -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose"></script>
    
    <script>
        // éŠæˆ²ç‹€æ…‹è®Šæ•¸
        let gameActive = false;
        let countdownActive = false;
        let countdownValue = 3;
        let countdownInterval = null;
        let playerGesture = null;
        let aiGesture = null;
        let scores = { player: 0, ai: 0, draw: 0 };
        let history = [];
        let handposeModel = null;
        let videoStream = null;
        let animationFrameId = null;
        let lastGestureTime = 0;
        let stableGesture = null;
        let gestureStableCount = 0;
        
        // DOM å…ƒç´ 
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvasContext = canvasElement.getContext('2d');
        const loadingElement = document.getElementById('loading');
        const detectionStatusElement = document.getElementById('detection-status');
        const playerGestureElement = document.getElementById('player-gesture');
        const playerStatusElement = document.getElementById('player-status');
        const playerGestureIcon = playerGestureElement.querySelector('.gesture-icon');
        const aiGestureElement = document.getElementById('ai-gesture');
        const aiStatusElement = document.getElementById('ai-status');
        const aiGestureIcon = aiGestureElement.querySelector('.gesture-icon');
        const countdownElement = document.getElementById('countdown');
        const gameResultElement = document.getElementById('game-result');
        const playerScoreElement = document.getElementById('player-score');
        const aiScoreElement = document.getElementById('ai-score');
        const drawScoreElement = document.getElementById('draw-score');
        const historyListElement = document.getElementById('history-list');
        const startButton = document.getElementById('start-btn');
        const stopButton = document.getElementById('stop-btn');
        const gameButton = document.getElementById('game-btn');
        
        // åˆå§‹åŒ–éŠæˆ²
        async function initGame() {
            // å˜—è©¦è¼‰å…¥æ‰‹éƒ¨è­˜åˆ¥æ¨¡å‹
            try {
                loadingElement.style.display = 'flex';
                detectionStatusElement.textContent = "æ­£åœ¨è¼‰å…¥æ‰‹éƒ¨è­˜åˆ¥æ¨¡å‹...";
                
                // è¼‰å…¥Handposeæ¨¡å‹
                handposeModel = await handpose.load();
                
                loadingElement.style.display = 'none';
                detectionStatusElement.textContent = "æ¨¡å‹è¼‰å…¥æˆåŠŸï¼è«‹å•Ÿå‹•æ”åƒé ­";
                
                console.log("Handposeæ¨¡å‹è¼‰å…¥æˆåŠŸ");
            } catch (error) {
                console.error("ç„¡æ³•è¼‰å…¥æ‰‹éƒ¨è­˜åˆ¥æ¨¡å‹:", error);
                loadingElement.innerHTML = `
                    <div style="text-align: center;">
                        <p style="color: #ff6b6b; margin-bottom: 15px;">ç„¡æ³•è¼‰å…¥æ‰‹éƒ¨è­˜åˆ¥æ¨¡å‹</p>
                        <p style="color: #aaa; font-size: 0.9rem;">è«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥å¾Œåˆ·æ–°é é¢</p>
                    </div>
                `;
                detectionStatusElement.textContent = "æ¨¡å‹è¼‰å…¥å¤±æ•—";
                detectionStatusElement.style.color = "#ff6b6b";
            }
        }
        
        // å•Ÿå‹•æ”åƒé ­
        async function startCamera() {
            try {
                detectionStatusElement.textContent = "æ­£åœ¨è«‹æ±‚æ”åƒé ­æ¬Šé™...";
                
                // è«‹æ±‚æ”åƒé ­è¨ªå•æ¬Šé™
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false
                });
                
                // å°‡è¦–é »æµè¨­å®šåˆ°videoå…ƒç´ 
                videoElement.srcObject = videoStream;
                
                // ç­‰å¾…è¦–é »è¼‰å…¥
                await new Promise((resolve) => {
                    videoElement.onloadedmetadata = () => {
                        resolve();
                    };
                });
                
                // è¨­å®šcanvaså°ºå¯¸èˆ‡è¦–é »ä¸€è‡´
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                
                detectionStatusElement.textContent = "æ”åƒé ­å·²å•Ÿå‹•ï¼Œæ­£åœ¨æª¢æ¸¬æ‰‹éƒ¨...";
                detectionStatusElement.classList.add('active');
                
                // å•Ÿç”¨/ç¦ç”¨æŒ‰éˆ•
                startButton.disabled = true;
                stopButton.disabled = false;
                gameButton.disabled = false;
                
                // é–‹å§‹æ‰‹éƒ¨æª¢æ¸¬
                detectHands();
                
            } catch (error) {
                console.error("ç„¡æ³•è¨ªå•æ”åƒé ­:", error);
                detectionStatusElement.textContent = "ç„¡æ³•è¨ªå•æ”åƒé ­ï¼Œè«‹æª¢æŸ¥æ¬Šé™";
                detectionStatusElement.style.color = "#ff6b6b";
            }
        }
        
        // åœæ­¢æ”åƒé ­
        function stopCamera() {
            if (videoStream) {
                // åœæ­¢æ‰€æœ‰è¦–é »è»Œé“
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            // æ¸…é™¤canvas
            canvasContext.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // é‡ç½®è¦–é »å…ƒç´ 
            videoElement.srcObject = null;
            
            detectionStatusElement.textContent = "æ”åƒé ­å·²åœæ­¢";
            detectionStatusElement.classList.remove('active');
            
            // é‡ç½®æ‰‹å‹¢æª¢æ¸¬ç‹€æ…‹
            playerStatusElement.textContent = "æ”åƒé ­å·²åœæ­¢";
            playerGestureIcon.textContent = "?";
            playerGestureElement.classList.remove('active');
            
            // å•Ÿç”¨/ç¦ç”¨æŒ‰éˆ•
            startButton.disabled = false;
            stopButton.disabled = true;
            gameButton.disabled = true;
        }
        
        // æª¢æ¸¬æ‰‹éƒ¨
        async function detectHands() {
            if (!handposeModel || !videoStream) return;
            
            // é æ¸¬æ‰‹éƒ¨ä½ç½®
            const predictions = await handposeModel.estimateHands(videoElement);
            
            // æ¸…é™¤canvas
            canvasContext.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // å¦‚æœæœ‰æª¢æ¸¬åˆ°æ‰‹éƒ¨
            if (predictions.length > 0) {
                detectionStatusElement.textContent = "å·²æª¢æ¸¬åˆ°æ‰‹éƒ¨";
                
                // ç²å–æ‰‹éƒ¨é—œéµé»
                const hand = predictions[0];
                
                // ç¹ªè£½æ‰‹éƒ¨é—œéµé»
                drawHand(hand.landmarks);
                
                // è­˜åˆ¥æ‰‹å‹¢
                const gesture = recognizeGesture(hand.landmarks);
                
                // æ›´æ–°ç©å®¶æ‰‹å‹¢é¡¯ç¤º
                updatePlayerGesture(gesture);
            } else {
                detectionStatusElement.textContent = "æœªæª¢æ¸¬åˆ°æ‰‹éƒ¨ï¼Œè«‹å°‡æ‰‹æ”¾åœ¨é¡é ­å‰";
                playerStatusElement.textContent = "æœªæª¢æ¸¬åˆ°æ‰‹éƒ¨";
                playerGestureIcon.textContent = "?";
                playerGestureElement.classList.remove('active');
            }
            
            // ç¹¼çºŒä¸‹ä¸€å¹€æª¢æ¸¬
            animationFrameId = requestAnimationFrame(detectHands);
        }
        
        // ç¹ªè£½æ‰‹éƒ¨é—œéµé»
        function drawHand(landmarks) {
            // ç¹ªè£½é—œéµé»
            for (let i = 0; i < landmarks.length; i++) {
                const [x, y] = landmarks[i];
                
                // ç¹ªè£½é»
                canvasContext.beginPath();
                canvasContext.arc(x, y, 5, 0, 2 * Math.PI);
                canvasContext.fillStyle = '#6c63ff';
                canvasContext.fill();
                
                // ç¹ªè£½ç·¨è™Ÿï¼ˆé™¤éŒ¯ç”¨ï¼‰
                canvasContext.font = '12px Arial';
                canvasContext.fillStyle = 'white';
                canvasContext.fillText(i, x + 8, y + 3);
            }
            
            // ç¹ªè£½é—œéµé»ä¹‹é–“çš„é€£æ¥ç·š
            const fingerConnections = [
                [0, 1], [1, 2], [2, 3], [3, 4], // æ‹‡æŒ‡
                [0, 5], [5, 6], [6, 7], [7, 8], // é£ŸæŒ‡
                [0, 9], [9, 10], [10, 11], [11, 12], // ä¸­æŒ‡
                [0, 13], [13, 14], [14, 15], [15, 16], // ç„¡åæŒ‡
                [0, 17], [17, 18], [18, 19], [19, 20], // å°æŒ‡
                [5, 9], [9, 13], [13, 17] // æ‰‹æŒåº•éƒ¨
            ];
            
            canvasContext.strokeStyle = '#ffd166';
            canvasContext.lineWidth = 2;
            
            for (const [start, end] of fingerConnections) {
                const [x1, y1] = landmarks[start];
                const [x2, y2] = landmarks[end];
                
                canvasContext.beginPath();
                canvasContext.moveTo(x1, y1);
                canvasContext.lineTo(x2, y2);
                canvasContext.stroke();
            }
        }
        
        // è­˜åˆ¥æ‰‹å‹¢ï¼ˆç°¡åŒ–ç‰ˆï¼‰
        function recognizeGesture(landmarks) {
            // ç°¡åŒ–æ‰‹å‹¢è­˜åˆ¥é‚è¼¯
            // é€™è£¡ä½¿ç”¨ä¸€å€‹ç°¡åŒ–çš„æ–¹æ³•ï¼šæ ¹æ“šæŒ‡å°–èˆ‡æ‰‹æŒçš„è·é›¢ä¾†åˆ¤æ–·æ‰‹æŒ‡æ˜¯å¦ä¼¸ç›´
            
            // æ‰‹æŒåŸºæº–é»ï¼ˆæ‰‹è…•ï¼‰
            const wrist = landmarks[0];
            
            // å„æ‰‹æŒ‡æŒ‡å°–çš„ç´¢å¼•
            const fingerTips = [4, 8, 12, 16, 20]; // æ‹‡æŒ‡ã€é£ŸæŒ‡ã€ä¸­æŒ‡ã€ç„¡åæŒ‡ã€å°æŒ‡
            const fingerBases = [2, 5, 9, 13, 17]; // å„æ‰‹æŒ‡çš„æ ¹éƒ¨
            
            let extendedFingers = 0;
            
            // æª¢æŸ¥æ¯å€‹æ‰‹æŒ‡æ˜¯å¦ä¼¸ç›´
            for (let i = 0; i < fingerTips.length; i++) {
                const tip = landmarks[fingerTips[i]];
                const base = landmarks[fingerBases[i]];
                
                // è¨ˆç®—æŒ‡å°–åˆ°æ‰‹æŒçš„è·é›¢
                const tipToWristDistance = distance(tip, wrist);
                const baseToWristDistance = distance(base, wrist);
                
                // å¦‚æœæŒ‡å°–è·é›¢æ‰‹è…•æ¯”æ ¹éƒ¨è·é›¢æ‰‹è…•é å¾ˆå¤šï¼Œå‰‡èªç‚ºæ‰‹æŒ‡æ˜¯ä¼¸ç›´çš„
                // å°æ–¼æ‹‡æŒ‡éœ€è¦ç‰¹æ®Šè™•ç†
                if (i === 0) {
                    // æ‹‡æŒ‡çš„åˆ¤æ–·é‚è¼¯
                    if (tipToWristDistance > baseToWristDistance * 1.3) {
                        extendedFingers++;
                    }
                } else {
                    if (tipToWristDistance > baseToWristDistance * 1.5) {
                        extendedFingers++;
                    }
                }
            }
            
            // æ ¹æ“šä¼¸ç›´çš„æ‰‹æŒ‡æ•¸é‡åˆ¤æ–·æ‰‹å‹¢
            if (extendedFingers === 0) {
                return 'rock'; // çŸ³é ­
            } else if (extendedFingers === 2 && 
                      landmarks[8][1] < landmarks[6][1] && // é£ŸæŒ‡ä¼¸ç›´
                      landmarks[12][1] < landmarks[10][1]) { // ä¸­æŒ‡ä¼¸ç›´
                return 'scissors'; // å‰ªåˆ€
            } else if (extendedFingers >= 4) {
                return 'paper'; // å¸ƒ
            } else {
                return 'unknown'; // æœªçŸ¥æ‰‹å‹¢
            }
        }
        
        // è¨ˆç®—å…©é»ä¹‹é–“çš„è·é›¢
        function distance(point1, point2) {
            const dx = point1[0] - point2[0];
            const dy = point1[1] - point2[1];
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        // æ›´æ–°ç©å®¶æ‰‹å‹¢é¡¯ç¤º
        function updatePlayerGesture(gesture) {
            const currentTime = Date.now();
            
            // ç‚ºäº†é¿å…æ‰‹å‹¢é »ç¹è®ŠåŒ–ï¼Œæˆ‘å€‘éœ€è¦æ‰‹å‹¢ç©©å®šä¸€æ®µæ™‚é–“
            if (gesture === stableGesture) {
                gestureStableCount++;
            } else {
                stableGesture = gesture;
                gestureStableCount = 1;
            }
            
            // å¦‚æœæ‰‹å‹¢ç©©å®šè¶…é5å¹€ï¼Œå‰‡æ›´æ–°é¡¯ç¤º
            if (gestureStableCount > 5) {
                playerGesture = gesture;
                
                // æ›´æ–°UI
                if (gesture === 'rock') {
                    playerGestureIcon.textContent = 'âœŠ';
                    playerStatusElement.textContent = 'çŸ³é ­';
                    playerGestureElement.classList.add('active');
                } else if (gesture === 'paper') {
                    playerGestureIcon.textContent = 'âœ‹';
                    playerStatusElement.textContent = 'å¸ƒ';
                    playerGestureElement.classList.add('active');
                } else if (gesture === 'scissors') {
                    playerGestureIcon.textContent = 'âœŒï¸';
                    playerStatusElement.textContent = 'å‰ªåˆ€';
                    playerGestureElement.classList.add('active');
                } else {
                    playerGestureIcon.textContent = '?';
                    playerStatusElement.textContent = 'æœªçŸ¥æ‰‹å‹¢';
                    playerGestureElement.classList.remove('active');
                }
            }
            
            // å¦‚æœéŠæˆ²æ­£åœ¨é€²è¡Œä¸”å€’æ•¸ä¸­ï¼Œå‰‡è¨˜éŒ„æœ€å¾Œçš„æ‰‹å‹¢
            if (countdownActive && currentTime > lastGestureTime + 100) {
                lastGestureTime = currentTime;
                
                // åœ¨å€’æ•¸çš„æœ€å¾Œ0.5ç§’é–å®šç©å®¶æ‰‹å‹¢
                if (countdownValue === 0 && gesture !== 'unknown') {
                    playerGesture = gesture;
                }
            }
        }
        
        // é–‹å§‹éŠæˆ²
        function startGame() {
            if (!videoStream || gameActive) return;
            
            gameActive = true;
            countdownActive = true;
            countdownValue = 3;
            
            // é‡ç½®æ‰‹å‹¢
            playerGesture = null;
            aiGesture = null;
            aiGestureIcon.textContent = '?';
            aiStatusElement.textContent = 'ç­‰å¾…ç©å®¶æ‰‹å‹¢';
            aiGestureElement.classList.remove('active');
            
            // ç¦ç”¨éŠæˆ²æŒ‰éˆ•
            gameButton.disabled = true;
            
            // é–‹å§‹å€’æ•¸
            countdownElement.textContent = countdownValue;
            gameResultElement.textContent = "æº–å‚™ï¼";
            
            countdownInterval = setInterval(() => {
                countdownValue--;
                countdownElement.textContent = countdownValue;
                
                if (countdownValue === 0) {
                    // å€’æ•¸çµæŸï¼Œé¡¯ç¤ºçµæœ
                    clearInterval(countdownInterval);
                    countdownActive = false;
                    
                    // å¦‚æœç©å®¶æ²’æœ‰æ‰‹å‹¢ï¼Œä½¿ç”¨æœ€å¾Œæª¢æ¸¬åˆ°çš„æ‰‹å‹¢
                    if (!playerGesture) {
                        playerGesture = stableGesture || 'unknown';
                    }
                    
                    // ç”Ÿæˆé›»è…¦æ‰‹å‹¢
                    generateAiGesture();
                    
                    // åˆ¤æ–·å‹è² 
                    determineWinner();
                    
                    // å•Ÿç”¨éŠæˆ²æŒ‰éˆ•
                    setTimeout(() => {
                        gameButton.disabled = false;
                        gameActive = false;
                    }, 3000);
                } else if (countdownValue > 0) {
                    gameResultElement.textContent = countdownValue === 1 ? "å‡ºæ‹³ï¼" : countdownValue + "...";
                }
            }, 1000);
        }
        
        // ç”Ÿæˆé›»è…¦æ‰‹å‹¢
        function generateAiGesture() {
            const gestures = ['rock', 'paper', 'scissors'];
            const randomIndex = Math.floor(Math.random() * 3);
            aiGesture = gestures[randomIndex];
            
            // æ›´æ–°UI
            if (aiGesture === 'rock') {
                aiGestureIcon.textContent = 'âœŠ';
                aiStatusElement.textContent = 'çŸ³é ­';
            } else if (aiGesture === 'paper') {
                aiGestureIcon.textContent = 'âœ‹';
                aiStatusElement.textContent = 'å¸ƒ';
            } else {
                aiGestureIcon.textContent = 'âœŒï¸';
                aiStatusElement.textContent = 'å‰ªåˆ€';
            }
            
            aiGestureElement.classList.add('active');
        }
        
        // åˆ¤æ–·å‹è² 
        function determineWinner() {
            // å¦‚æœç©å®¶æ‰‹å‹¢æœªçŸ¥ï¼Œè¦–ç‚ºç„¡æ•ˆ
            if (playerGesture === 'unknown') {
                gameResultElement.textContent = "ç„¡æ³•è­˜åˆ¥æ‚¨çš„æ‰‹å‹¢ï¼";
                return;
            }
            
            // åˆ¤æ–·å‹è² 
            let result = '';
            
            if (playerGesture === aiGesture) {
                result = "å¹³å±€ï¼";
                scores.draw++;
            } else if (
                (playerGesture === 'rock' && aiGesture === 'scissors') ||
                (playerGesture === 'paper' && aiGesture === 'rock') ||
                (playerGesture === 'scissors' && aiGesture === 'paper')
            ) {
                result = "ç©å®¶è´äº†ï¼";
                scores.player++;
            } else {
                result = "é›»è…¦è´äº†ï¼";
                scores.ai++;
            }
            
            gameResultElement.textContent = result;
            
            // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
            updateScores();
            
            // è¨˜éŒ„éŠæˆ²æ­·å²
            recordGameHistory(result);
        }
        
        // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
        function updateScores() {
            playerScoreElement.textContent = scores.player;
            aiScoreElement.textContent = scores.ai;
            drawScoreElement.textContent = scores.draw;
        }
        
        // è¨˜éŒ„éŠæˆ²æ­·å²
        function recordGameHistory(result) {
            // ç²å–æ‰‹å‹¢é¡¯ç¤ºåç¨±
            const getGestureName = (gesture) => {
                if (gesture === 'rock') return 'âœŠ çŸ³é ­';
                if (gesture === 'paper') return 'âœ‹ å¸ƒ';
                if (gesture === 'scissors') return 'âœŒï¸ å‰ªåˆ€';
                return '? æœªçŸ¥';
            };
            
            const playerGestureName = getGestureName(playerGesture);
            const aiGestureName = getGestureName(aiGesture);
            
            // å‰µå»ºæ­·å²è¨˜éŒ„é …ç›®
            const historyItem = document.createElement('div');
            historyItem.classList.add('history-item');
            
            // æ ¹æ“šçµæœæ·»åŠ æ¨£å¼
            if (result.includes("ç©å®¶è´äº†")) {
                historyItem.innerHTML = `
                    <span class="history-winner">ç©å®¶ ${playerGestureName}</span>
                    <span> vs </span>
                    <span class="history-looser">é›»è…¦ ${aiGestureName}</span>
                `;
            } else if (result.includes("é›»è…¦è´äº†")) {
                historyItem.innerHTML = `
                    <span class="history-looser">ç©å®¶ ${playerGestureName}</span>
                    <span> vs </span>
                    <span class="history-winner">é›»è…¦ ${aiGestureName}</span>
                `;
            } else {
                historyItem.innerHTML = `
                    <span>ç©å®¶ ${playerGestureName}</span>
                    <span> vs </span>
                    <span>é›»è…¦ ${aiGestureName}</span>
                `;
            }
            
            // æ·»åŠ åˆ°æ­·å²åˆ—è¡¨
            if (historyListElement.firstChild && historyListElement.firstChild.textContent === "éŠæˆ²å°šæœªé–‹å§‹") {
                historyListElement.innerHTML = '';
            }
            
            historyListElement.insertBefore(historyItem, historyListElement.firstChild);
            
            // é™åˆ¶æ­·å²è¨˜éŒ„æ•¸é‡
            if (historyListElement.children.length > 10) {
                historyListElement.removeChild(historyListElement.lastChild);
            }
        }
        
        // äº‹ä»¶ç›£è½å™¨
        startButton.addEventListener('click', startCamera);
        stopButton.addEventListener('click', stopCamera);
        gameButton.addEventListener('click', startGame);
        
        // åˆå§‹åŒ–éŠæˆ²
        initGame();
        
        // é é¢å¸è¼‰æ™‚åœæ­¢æ”åƒé ­
        window.addEventListener('beforeunload', () => {
            if (videoStream) {
                stopCamera();
            }
        });
    </script>
</body>
</html>